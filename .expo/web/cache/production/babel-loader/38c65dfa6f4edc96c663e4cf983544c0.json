{"ast":null,"code":"\"use strict\";var _regeneratorRuntime=require(\"/Users/fernandorojo/Developer/messing/rea-tree/node_modules/next/dist/compiled/@babel/runtime/regenerator\");var _asyncToGenerator=require(\"/Users/fernandorojo/Developer/messing/rea-tree/node_modules/next/dist/compiled/@babel/runtime/helpers/asyncToGenerator\");function _createForOfIteratorHelper(o,allowArrayLike){var it=typeof Symbol!==\"undefined\"&&o[Symbol.iterator]||o[\"@@iterator\"];if(!it){if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&typeof o.length===\"number\"){if(it)o=it;var i=0;var F=function F(){};return{s:F,n:function n(){if(i>=o.length)return{done:true};return{done:false,value:o[i++]};},e:function e(_e){throw _e;},f:F};}throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\");}var normalCompletion=true,didErr=false,err;return{s:function s(){it=it.call(o);},n:function n(){var step=it.next();normalCompletion=step.done;return step;},e:function e(_e2){didErr=true;err=_e2;},f:function f(){try{if(!normalCompletion&&it[\"return\"]!=null)it[\"return\"]();}finally{if(didErr)throw err;}}};}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o===\"string\")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n===\"Object\"&&o.constructor)n=o.constructor.name;if(n===\"Map\"||n===\"Set\")return Array.from(o);if(n===\"Arguments\"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen);}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++){arr2[i]=arr[i];}return arr2;}var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{\"default\":mod};};Object.defineProperty(exports,\"__esModule\",{value:true});exports.clearUnusedCachesAsync=exports.cacheImageAsync=exports.getImageFromCacheAsync=exports.ensureCacheDirectory=exports.createCacheKeyWithDirectoryAsync=exports.createCacheKey=void 0;var crypto_1=__importDefault(require(\"crypto\"));var fs_extra_1=require(\"fs-extra\");var path_1=require(\"path\");var CACHE_LOCATION='.expo/web/cache/production/images';var cacheKeys={};// Calculate SHA256 Checksum value of a file based on its contents\nfunction calculateHash(filePath){var contents=filePath.startsWith('http')?filePath:(0,fs_extra_1.readFileSync)(filePath);return crypto_1[\"default\"].createHash('sha256').update(contents).digest('hex');}// Create a hash key for caching the images between builds\nfunction createCacheKey(fileSource,properties){var hash=calculateHash(fileSource);return[hash].concat(properties).filter(Boolean).join('-');}exports.createCacheKey=createCacheKey;function createCacheKeyWithDirectoryAsync(_x,_x2,_x3){return _createCacheKeyWithDirectoryAsync.apply(this,arguments);}function _createCacheKeyWithDirectoryAsync(){_createCacheKeyWithDirectoryAsync=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(projectRoot,type,icon){var cacheKey;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:cacheKey=\"\".concat(type,\"-\").concat(createCacheKey(icon.src,[icon.resizeMode,icon.backgroundColor]));if(cacheKey in cacheKeys){_context.next=5;break;}_context.next=4;return ensureCacheDirectory(projectRoot,type,cacheKey);case 4:cacheKeys[cacheKey]=_context.sent;case 5:return _context.abrupt(\"return\",cacheKey);case 6:case\"end\":return _context.stop();}}},_callee);}));return _createCacheKeyWithDirectoryAsync.apply(this,arguments);}exports.createCacheKeyWithDirectoryAsync=createCacheKeyWithDirectoryAsync;function ensureCacheDirectory(_x4,_x5,_x6){return _ensureCacheDirectory.apply(this,arguments);}function _ensureCacheDirectory(){_ensureCacheDirectory=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(projectRoot,type,cacheKey){var cacheFolder;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:cacheFolder=(0,path_1.join)(projectRoot,CACHE_LOCATION,type,cacheKey);_context2.next=3;return(0,fs_extra_1.ensureDir)(cacheFolder);case 3:return _context2.abrupt(\"return\",cacheFolder);case 4:case\"end\":return _context2.stop();}}},_callee2);}));return _ensureCacheDirectory.apply(this,arguments);}exports.ensureCacheDirectory=ensureCacheDirectory;function getImageFromCacheAsync(_x7,_x8){return _getImageFromCacheAsync.apply(this,arguments);}function _getImageFromCacheAsync(){_getImageFromCacheAsync=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(fileName,cacheKey){return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.prev=0;_context3.next=3;return(0,fs_extra_1.readFile)((0,path_1.resolve)(cacheKeys[cacheKey],fileName));case 3:return _context3.abrupt(\"return\",_context3.sent);case 6:_context3.prev=6;_context3.t0=_context3[\"catch\"](0);return _context3.abrupt(\"return\",null);case 9:case\"end\":return _context3.stop();}}},_callee3,null,[[0,6]]);}));return _getImageFromCacheAsync.apply(this,arguments);}exports.getImageFromCacheAsync=getImageFromCacheAsync;function cacheImageAsync(_x9,_x10,_x11){return _cacheImageAsync.apply(this,arguments);}function _cacheImageAsync(){_cacheImageAsync=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(fileName,buffer,cacheKey){var message;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.prev=0;_context4.next=3;return(0,fs_extra_1.writeFile)((0,path_1.resolve)(cacheKeys[cacheKey],fileName),buffer);case 3:_context4.next=9;break;case 5:_context4.prev=5;_context4.t0=_context4[\"catch\"](0);message=_context4.t0.message;console.warn(\"Error caching image: \\\"\".concat(fileName,\"\\\". \").concat(message));case 9:case\"end\":return _context4.stop();}}},_callee4,null,[[0,5]]);}));return _cacheImageAsync.apply(this,arguments);}exports.cacheImageAsync=cacheImageAsync;function clearUnusedCachesAsync(_x12,_x13){return _clearUnusedCachesAsync.apply(this,arguments);}function _clearUnusedCachesAsync(){_clearUnusedCachesAsync=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(projectRoot,type){var cacheFolder,currentCaches,deleteCachePromises,_iterator,_step,cache;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:// Clean up any old caches\ncacheFolder=(0,path_1.join)(projectRoot,CACHE_LOCATION,type);_context5.next=3;return(0,fs_extra_1.ensureDir)(cacheFolder);case 3:currentCaches=(0,fs_extra_1.readdirSync)(cacheFolder);if(Array.isArray(currentCaches)){_context5.next=7;break;}console.warn('Failed to read the icon cache');return _context5.abrupt(\"return\");case 7:deleteCachePromises=[];_iterator=_createForOfIteratorHelper(currentCaches);_context5.prev=9;_iterator.s();case 11:if((_step=_iterator.n()).done){_context5.next=18;break;}cache=_step.value;if(!cache.startsWith('.')){_context5.next=15;break;}return _context5.abrupt(\"continue\",16);case 15:// delete\nif(!(cache in cacheKeys)){deleteCachePromises.push((0,fs_extra_1.remove)((0,path_1.join)(cacheFolder,cache)));}case 16:_context5.next=11;break;case 18:_context5.next=23;break;case 20:_context5.prev=20;_context5.t0=_context5[\"catch\"](9);_iterator.e(_context5.t0);case 23:_context5.prev=23;_iterator.f();return _context5.finish(23);case 26:_context5.next=28;return Promise.all(deleteCachePromises);case 28:case\"end\":return _context5.stop();}}},_callee5,null,[[9,20,23,26]]);}));return _clearUnusedCachesAsync.apply(this,arguments);}exports.clearUnusedCachesAsync=clearUnusedCachesAsync;","map":{"version":3,"sources":["../src/Cache.ts"],"names":[],"mappings":"ugEAAA,GAAA,CAAA,QAAA,CAAA,eAAA,CAAA,OAAA,CAAA,QAAA,CAAA,CAAA,CACA,GAAA,CAAA,UAAA,CAAA,OAAA,CAAA,UAAA,CAAA,CACA,GAAA,CAAA,MAAA,CAAA,OAAA,CAAA,MAAA,CAAA,CAIA,GAAM,CAAA,cAAc,CAAG,mCAAvB,CAEA,GAAM,CAAA,SAAS,CAA8B,EAA7C,CAEA;AACA,QAAS,CAAA,aAAT,CAAuB,QAAvB,CAAuC,CACrC,GAAM,CAAA,QAAQ,CAAG,QAAQ,CAAC,UAAT,CAAoB,MAApB,EAA8B,QAA9B,CAAyC,CAAA,EAAA,UAAA,CAAA,YAAA,EAAa,QAAb,CAA1D,CACA,MAAO,CAAA,QAAA,WAAA,CAAO,UAAP,CAAkB,QAAlB,EAA4B,MAA5B,CAAmC,QAAnC,EAA6C,MAA7C,CAAoD,KAApD,CAAP,CACD,CAED;AACA,QAAgB,CAAA,cAAhB,CAA+B,UAA/B,CAAmD,UAAnD,CAAuE,CACrE,GAAM,CAAA,IAAI,CAAG,aAAa,CAAC,UAAD,CAA1B,CACA,MAAO,CAAC,IAAD,EAAO,MAAP,CAAc,UAAd,EAA0B,MAA1B,CAAiC,OAAjC,EAA0C,IAA1C,CAA+C,GAA/C,CAAP,CACD,CAHD,OAAA,CAAA,cAAA,CAAA,cAAA,C,QAKsB,CAAA,gC,oNAAf,iBACL,WADK,CAEL,IAFK,CAGL,IAHK,+HAKC,QALD,WAKe,IALf,aAKuB,cAAc,CAAC,IAAI,CAAC,GAAN,CAAW,CAAC,IAAI,CAAC,UAAN,CAAkB,IAAI,CAAC,eAAvB,CAAX,CALrC,KAMC,QAAQ,GAAI,CAAA,SANb,+CAOyB,CAAA,oBAAoB,CAAC,WAAD,CAAc,IAAd,CAAoB,QAApB,CAP7C,QAOH,SAAS,CAAC,QAAD,CAPN,sDAUE,QAVF,wD,mEAAP,OAAA,CAAA,gCAAA,CAAA,gCAAA,C,QAasB,CAAA,oB,iLAAf,kBACL,WADK,CAEL,IAFK,CAGL,QAHK,sIAKC,WALD,CAKe,CAAA,EAAA,MAAA,CAAA,IAAA,EAAK,WAAL,CAAkB,cAAlB,CAAkC,IAAlC,CAAwC,QAAxC,CALf,wBAMC,CAAA,EAAA,UAAA,CAAA,SAAA,EAAU,WAAV,CAND,yCAOE,WAPF,0D,uDAAP,OAAA,CAAA,oBAAA,CAAA,oBAAA,C,QAUsB,CAAA,sB,mLAAf,kBACL,QADK,CAEL,QAFK,8JAKU,CAAA,EAAA,UAAA,CAAA,QAAA,EAAS,CAAA,EAAA,MAAA,CAAA,OAAA,EAAQ,SAAS,CAAC,QAAD,CAAjB,CAA6B,QAA7B,CAAT,CALV,qJAOI,IAPJ,uE,yDAAP,OAAA,CAAA,sBAAA,CAAA,sBAAA,C,QAWsB,CAAA,e,oKAAf,kBACL,QADK,CAEL,MAFK,CAGL,QAHK,0KAMG,CAAA,EAAA,UAAA,CAAA,SAAA,EAAU,CAAA,EAAA,MAAA,CAAA,OAAA,EAAQ,SAAS,CAAC,QAAD,CAAjB,CAA6B,QAA7B,CAAV,CAAkD,MAAlD,CANH,0FAOM,OAPN,cAOM,OAPN,CAQH,OAAO,CAAC,IAAR,kCAAsC,QAAtC,gBAAoD,OAApD,GARG,qE,kDAAP,OAAA,CAAA,eAAA,CAAA,eAAA,C,QAYsB,CAAA,sB,qLAAf,kBAAsC,WAAtC,CAA2D,IAA3D,8LACL;AACM,WAFD,CAEe,CAAA,EAAA,MAAA,CAAA,IAAA,EAAK,WAAL,CAAkB,cAAlB,CAAkC,IAAlC,CAFf,wBAGC,CAAA,EAAA,UAAA,CAAA,SAAA,EAAU,WAAV,CAHD,QAIC,aAJD,CAIiB,CAAA,EAAA,UAAA,CAAA,WAAA,EAAY,WAAZ,CAJjB,IAMA,KAAK,CAAC,OAAN,CAAc,aAAd,CANA,0BAOH,OAAO,CAAC,IAAR,CAAa,+BAAb,EAPG,yCAUC,mBAVD,CAUwC,EAVxC,sCAWe,aAXf,iGAWM,KAXN,iBAaC,KAAK,CAAC,UAAN,CAAiB,GAAjB,CAbD,0EAiBH;AACA,GAAI,EAAE,KAAK,GAAI,CAAA,SAAX,CAAJ,CAA2B,CACzB,mBAAmB,CAAC,IAApB,CAAyB,CAAA,EAAA,UAAA,CAAA,MAAA,EAAO,CAAA,EAAA,MAAA,CAAA,IAAA,EAAK,WAAL,CAAkB,KAAlB,CAAP,CAAzB,EACD,CApBE,2PAuBC,CAAA,OAAO,CAAC,GAAR,CAAY,mBAAZ,CAvBD,8E,yDAAP,OAAA,CAAA,sBAAA,CAAA,sBAAA","sourcesContent":["import crypto from 'crypto';\nimport { ensureDir, readdirSync, readFile, readFileSync, remove, writeFile } from 'fs-extra';\nimport { join, resolve } from 'path';\n\nimport { ImageOptions } from './Image.types';\n\nconst CACHE_LOCATION = '.expo/web/cache/production/images';\n\nconst cacheKeys: { [key: string]: string } = {};\n\n// Calculate SHA256 Checksum value of a file based on its contents\nfunction calculateHash(filePath: string): string {\n  const contents = filePath.startsWith('http') ? filePath : readFileSync(filePath);\n  return crypto.createHash('sha256').update(contents).digest('hex');\n}\n\n// Create a hash key for caching the images between builds\nexport function createCacheKey(fileSource: string, properties: string[]): string {\n  const hash = calculateHash(fileSource);\n  return [hash].concat(properties).filter(Boolean).join('-');\n}\n\nexport async function createCacheKeyWithDirectoryAsync(\n  projectRoot: string,\n  type: string,\n  icon: ImageOptions\n): Promise<string> {\n  const cacheKey = `${type}-${createCacheKey(icon.src, [icon.resizeMode, icon.backgroundColor])}`;\n  if (!(cacheKey in cacheKeys)) {\n    cacheKeys[cacheKey] = await ensureCacheDirectory(projectRoot, type, cacheKey);\n  }\n\n  return cacheKey;\n}\n\nexport async function ensureCacheDirectory(\n  projectRoot: string,\n  type: string,\n  cacheKey: string\n): Promise<string> {\n  const cacheFolder = join(projectRoot, CACHE_LOCATION, type, cacheKey);\n  await ensureDir(cacheFolder);\n  return cacheFolder;\n}\n\nexport async function getImageFromCacheAsync(\n  fileName: string,\n  cacheKey: string\n): Promise<null | Buffer> {\n  try {\n    return await readFile(resolve(cacheKeys[cacheKey], fileName));\n  } catch {\n    return null;\n  }\n}\n\nexport async function cacheImageAsync(\n  fileName: string,\n  buffer: Buffer,\n  cacheKey: string\n): Promise<void> {\n  try {\n    await writeFile(resolve(cacheKeys[cacheKey], fileName), buffer);\n  } catch ({ message }) {\n    console.warn(`Error caching image: \"${fileName}\". ${message}`);\n  }\n}\n\nexport async function clearUnusedCachesAsync(projectRoot: string, type: string): Promise<void> {\n  // Clean up any old caches\n  const cacheFolder = join(projectRoot, CACHE_LOCATION, type);\n  await ensureDir(cacheFolder);\n  const currentCaches = readdirSync(cacheFolder);\n\n  if (!Array.isArray(currentCaches)) {\n    console.warn('Failed to read the icon cache');\n    return;\n  }\n  const deleteCachePromises: Promise<void>[] = [];\n  for (const cache of currentCaches) {\n    // skip hidden folders\n    if (cache.startsWith('.')) {\n      continue;\n    }\n\n    // delete\n    if (!(cache in cacheKeys)) {\n      deleteCachePromises.push(remove(join(cacheFolder, cache)));\n    }\n  }\n\n  await Promise.all(deleteCachePromises);\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"script"}
{"ast":null,"code":"\"use strict\";var _defineProperty=require(\"/Users/fernandorojo/Developer/messing/rea-tree/node_modules/next/dist/compiled/@babel/runtime/helpers/defineProperty\");var _regeneratorRuntime=require(\"/Users/fernandorojo/Developer/messing/rea-tree/node_modules/next/dist/compiled/@babel/runtime/regenerator\");var _asyncToGenerator=require(\"/Users/fernandorojo/Developer/messing/rea-tree/node_modules/next/dist/compiled/@babel/runtime/helpers/asyncToGenerator\");function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;})),keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{};i%2?ownKeys(Object(source),!0).forEach(function(key){_defineProperty(target,key,source[key]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}return target;}var __createBinding=this&&this.__createBinding||(Object.create?function(o,m,k,k2){if(k2===undefined)k2=k;var desc=Object.getOwnPropertyDescriptor(m,k);if(!desc||(\"get\"in desc?!m.__esModule:desc.writable||desc.configurable)){desc={enumerable:true,get:function get(){return m[k];}};}Object.defineProperty(o,k2,desc);}:function(o,m,k,k2){if(k2===undefined)k2=k;o[k2]=m[k];});var __setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(o,v){Object.defineProperty(o,\"default\",{enumerable:true,value:v});}:function(o,v){o[\"default\"]=v;});var __importStar=this&&this.__importStar||function(mod){if(mod&&mod.__esModule)return mod;var result={};if(mod!=null)for(var k in mod){if(k!==\"default\"&&Object.prototype.hasOwnProperty.call(mod,k))__createBinding(result,mod,k);}__setModuleDefault(result,mod);return result;};var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{\"default\":mod};};Object.defineProperty(exports,\"__esModule\",{value:true});exports.compositeImagesAsync=exports.generateFaviconAsync=exports.generateImageAsync=void 0;var chalk_1=__importDefault(require(\"chalk\"));var mime_1=__importDefault(require(\"mime\"));var Cache=__importStar(require(\"./Cache\"));var Download=__importStar(require(\"./Download\"));var Ico=__importStar(require(\"./Ico\"));var Jimp=__importStar(require(\"./jimp\"));var Sharp=__importStar(require(\"./sharp\"));var supportedMimeTypes=['image/png','image/jpeg','image/webp','image/gif'];var hasWarned=false;function resizeImagesAsync(_x,_x2){return _resizeImagesAsync.apply(this,arguments);}function _resizeImagesAsync(){_resizeImagesAsync=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(buffer,sizes){var sharp;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return getSharpAsync();case 2:sharp=_context.sent;if(sharp){_context.next=5;break;}return _context.abrupt(\"return\",Jimp.resizeBufferAsync(buffer,sizes));case 5:return _context.abrupt(\"return\",Sharp.resizeBufferAsync(buffer,sizes));case 6:case\"end\":return _context.stop();}}},_callee);}));return _resizeImagesAsync.apply(this,arguments);}function resizeAsync(_x3){return _resizeAsync.apply(this,arguments);}function _resizeAsync(){_resizeAsync=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(imageOptions){var sharp,width,height,backgroundColor,resizeMode,inputOptions,jimp,imgBuffer,sharpBuffer,mask,message;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return getSharpAsync();case 2:sharp=_context2.sent;width=imageOptions.width,height=imageOptions.height,backgroundColor=imageOptions.backgroundColor,resizeMode=imageOptions.resizeMode;if(sharp){_context2.next=17;break;}inputOptions={input:imageOptions.src,quality:100};_context2.next=8;return Jimp.resize(inputOptions,{width:width,height:height,fit:resizeMode,background:backgroundColor});case 8:jimp=_context2.sent;if(imageOptions.removeTransparency){jimp.colorType(2);}if(!imageOptions.borderRadius){_context2.next=13;break;}_context2.next=13;return Jimp.circleAsync(jimp);case 13:_context2.next=15;return jimp.getBufferAsync(jimp.getMIME());case 15:imgBuffer=_context2.sent;return _context2.abrupt(\"return\",imgBuffer);case 17:_context2.prev=17;sharpBuffer=sharp(imageOptions.src).ensureAlpha().resize(width,height,{fit:resizeMode,background:'transparent'});// Skip an extra step if the background is explicitly transparent.\nif(backgroundColor&&backgroundColor!=='transparent'){// Add the background color to the image\nsharpBuffer=sharpBuffer.composite([{// create a background color\ninput:{create:{width:width,height:height,// allow alpha colors\nchannels:imageOptions.removeTransparency?3:4,background:backgroundColor}},// dest-over makes the first image (input) appear on top of the created image (background color)\nblend:'dest-over'}]);}else if(imageOptions.removeTransparency){sharpBuffer.flatten();}if(imageOptions.borderRadius){mask=Buffer.from(\"<svg><rect x=\\\"0\\\" y=\\\"0\\\" width=\\\"\".concat(width,\"\\\" height=\\\"\").concat(height,\"\\\" \\n        rx=\\\"\").concat(imageOptions.borderRadius,\"\\\" ry=\\\"\").concat(imageOptions.borderRadius,\"\\\" \\n        fill=\\\"\").concat(backgroundColor&&backgroundColor!=='transparent'?backgroundColor:'none',\"\\\" /></svg>\"));sharpBuffer.composite([{input:mask,blend:'dest-over'}]);}_context2.next=23;return sharpBuffer.png().toBuffer();case 23:return _context2.abrupt(\"return\",_context2.sent);case 26:_context2.prev=26;_context2.t0=_context2[\"catch\"](17);message=_context2.t0.message;throw new Error(\"It was not possible to generate splash screen '\".concat(imageOptions.src,\"'. \").concat(message));case 30:case\"end\":return _context2.stop();}}},_callee2,null,[[17,26]]);}));return _resizeAsync.apply(this,arguments);}function getSharpAsync(){return _getSharpAsync.apply(this,arguments);}function _getSharpAsync(){_getSharpAsync=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var sharp;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return Sharp.isAvailableAsync();case 2:if(!_context3.sent){_context3.next=6;break;}_context3.next=5;return Sharp.findSharpInstanceAsync();case 5:sharp=_context3.sent;case 6:return _context3.abrupt(\"return\",sharp);case 7:case\"end\":return _context3.stop();}}},_callee3);}));return _getSharpAsync.apply(this,arguments);}function getDimensionsId(imageOptions){return imageOptions.width===imageOptions.height?\"\".concat(imageOptions.width):\"\".concat(imageOptions.width,\"x\").concat(imageOptions.height);}function maybeWarnAboutInstallingSharpAsync(){return _maybeWarnAboutInstallingSharpAsync.apply(this,arguments);}function _maybeWarnAboutInstallingSharpAsync(){_maybeWarnAboutInstallingSharpAsync=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(){return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.t0=!hasWarned;if(!_context4.t0){_context4.next=5;break;}_context4.next=4;return Sharp.isAvailableAsync();case 4:_context4.t0=!_context4.sent;case 5:if(!_context4.t0){_context4.next=8;break;}hasWarned=true;console.warn(chalk_1[\"default\"].yellow(\"Using node to generate images. This is much slower than using native packages.\\n\\u203A Optionally you can stop the process and try again after successfully running `npm install -g sharp-cli`.\\n\"));case 8:case\"end\":return _context4.stop();}}},_callee4);}));return _maybeWarnAboutInstallingSharpAsync.apply(this,arguments);}function ensureImageOptionsAsync(_x4){return _ensureImageOptionsAsync.apply(this,arguments);}function _ensureImageOptionsAsync(){_ensureImageOptionsAsync=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(imageOptions){var icon,mimeType;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.t0=_objectSpread;_context5.t1=_objectSpread({},imageOptions);_context5.t2={};_context5.next=5;return Download.downloadOrUseCachedImage(imageOptions.src);case 5:_context5.t3=_context5.sent;_context5.t4={src:_context5.t3};icon=(0,_context5.t0)(_context5.t1,_context5.t2,_context5.t4);// Default to contain\nif(!icon.resizeMode){icon.resizeMode='contain';}mimeType=mime_1[\"default\"].getType(icon.src);if(mimeType){_context5.next=12;break;}throw new Error(\"Invalid mimeType for image with source: \".concat(icon.src));case 12:if(supportedMimeTypes.includes(mimeType)){_context5.next=14;break;}throw new Error(\"Supplied image is not a supported image type: \".concat(imageOptions.src));case 14:if(!icon.name){icon.name=\"icon_\".concat(getDimensionsId(imageOptions),\".\").concat(mime_1[\"default\"].getExtension(mimeType));}return _context5.abrupt(\"return\",icon);case 16:case\"end\":return _context5.stop();}}},_callee5);}));return _ensureImageOptionsAsync.apply(this,arguments);}function generateImageAsync(_x5,_x6){return _generateImageAsync.apply(this,arguments);}function _generateImageAsync(){_generateImageAsync=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee6(options,imageOptions){var icon,cacheKey,name,source;return _regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:_context6.next=2;return ensureImageOptionsAsync(imageOptions);case 2:icon=_context6.sent;if(options.cacheType){_context6.next=11;break;}_context6.next=6;return maybeWarnAboutInstallingSharpAsync();case 6:_context6.t0=icon.name;_context6.next=9;return resizeAsync(icon);case 9:_context6.t1=_context6.sent;return _context6.abrupt(\"return\",{name:_context6.t0,source:_context6.t1});case 11:_context6.next=13;return Cache.createCacheKeyWithDirectoryAsync(options.projectRoot,options.cacheType,icon);case 13:cacheKey=_context6.sent;name=icon.name;_context6.next=17;return Cache.getImageFromCacheAsync(name,cacheKey);case 17:source=_context6.sent;if(source){_context6.next=26;break;}_context6.next=21;return maybeWarnAboutInstallingSharpAsync();case 21:_context6.next=23;return resizeAsync(icon);case 23:source=_context6.sent;_context6.next=26;return Cache.cacheImageAsync(name,source,cacheKey);case 26:return _context6.abrupt(\"return\",{name:name,source:source});case 27:case\"end\":return _context6.stop();}}},_callee6);}));return _generateImageAsync.apply(this,arguments);}exports.generateImageAsync=generateImageAsync;function generateFaviconAsync(_x7){return _generateFaviconAsync.apply(this,arguments);}function _generateFaviconAsync(){_generateFaviconAsync=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee7(pngImageBuffer){var sizes,buffers,_args7=arguments;return _regeneratorRuntime.wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:sizes=_args7.length>1&&_args7[1]!==undefined?_args7[1]:[16,32,48];_context7.next=3;return resizeImagesAsync(pngImageBuffer,sizes);case 3:buffers=_context7.sent;_context7.next=6;return Ico.generateAsync(buffers);case 6:return _context7.abrupt(\"return\",_context7.sent);case 7:case\"end\":return _context7.stop();}}},_callee7);}));return _generateFaviconAsync.apply(this,arguments);}exports.generateFaviconAsync=generateFaviconAsync;/**\n * Layers the provided foreground image over the provided background image.\n *\n * @param foregroundImageBuffer\n * @param foregroundImageBuffer\n * @param x pixel offset from the left edge, defaults to 0.\n * @param y pixel offset from the top edge, defaults to 0.\n */function compositeImagesAsync(_x8){return _compositeImagesAsync.apply(this,arguments);}function _compositeImagesAsync(){_compositeImagesAsync=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee8(_ref){var foreground,background,_ref$x,x,_ref$y,y,sharp,image;return _regeneratorRuntime.wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:foreground=_ref.foreground,background=_ref.background,_ref$x=_ref.x,x=_ref$x===void 0?0:_ref$x,_ref$y=_ref.y,y=_ref$y===void 0?0:_ref$y;_context8.next=3;return getSharpAsync();case 3:sharp=_context8.sent;if(sharp){_context8.next=17;break;}_context8.next=7;return Jimp.getJimpImageAsync(background);case 7:_context8.t0=_context8.sent;_context8.next=10;return Jimp.getJimpImageAsync(foreground);case 10:_context8.t1=_context8.sent;_context8.t2=x;_context8.t3=y;image=_context8.t0.composite.call(_context8.t0,_context8.t1,_context8.t2,_context8.t3);_context8.next=16;return image.getBufferAsync(image.getMIME());case 16:return _context8.abrupt(\"return\",_context8.sent);case 17:_context8.next=19;return sharp(background).composite([{input:foreground,left:x,top:y}]).toBuffer();case 19:return _context8.abrupt(\"return\",_context8.sent);case 20:case\"end\":return _context8.stop();}}},_callee8);}));return _compositeImagesAsync.apply(this,arguments);}exports.compositeImagesAsync=compositeImagesAsync;","map":{"version":3,"sources":["../src/Image.ts"],"names":[],"mappings":"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","sourcesContent":["import chalk from 'chalk';\nimport mime from 'mime';\n\nimport * as Cache from './Cache';\nimport * as Download from './Download';\nimport * as Ico from './Ico';\nimport { ImageOptions } from './Image.types';\nimport * as Jimp from './jimp';\nimport * as Sharp from './sharp';\n\nconst supportedMimeTypes = ['image/png', 'image/jpeg', 'image/webp', 'image/gif'];\n\nlet hasWarned: boolean = false;\n\nasync function resizeImagesAsync(buffer: Buffer, sizes: number[]): Promise<Buffer[]> {\n  const sharp = await getSharpAsync();\n  if (!sharp) {\n    return Jimp.resizeBufferAsync(buffer, sizes);\n  }\n  return Sharp.resizeBufferAsync(buffer, sizes);\n}\n\nasync function resizeAsync(imageOptions: ImageOptions): Promise<Buffer> {\n  const sharp: any = await getSharpAsync();\n  const { width, height, backgroundColor, resizeMode } = imageOptions;\n  if (!sharp) {\n    const inputOptions: any = { input: imageOptions.src, quality: 100 };\n    const jimp = await Jimp.resize(inputOptions, {\n      width,\n      height,\n      fit: resizeMode,\n      background: backgroundColor,\n    });\n\n    if (imageOptions.removeTransparency) {\n      jimp.colorType(2);\n    }\n    if (imageOptions.borderRadius) {\n      // TODO: support setting border radius with Jimp. Currently only support making the image a circle\n      await Jimp.circleAsync(jimp);\n    }\n\n    const imgBuffer = await jimp.getBufferAsync(jimp.getMIME());\n    return imgBuffer;\n  }\n  try {\n    let sharpBuffer = sharp(imageOptions.src)\n      .ensureAlpha()\n      .resize(width, height, { fit: resizeMode, background: 'transparent' });\n\n    // Skip an extra step if the background is explicitly transparent.\n    if (backgroundColor && backgroundColor !== 'transparent') {\n      // Add the background color to the image\n      sharpBuffer = sharpBuffer.composite([\n        {\n          // create a background color\n          input: {\n            create: {\n              width,\n              height,\n              // allow alpha colors\n              channels: imageOptions.removeTransparency ? 3 : 4,\n              background: backgroundColor,\n            },\n          },\n          // dest-over makes the first image (input) appear on top of the created image (background color)\n          blend: 'dest-over',\n        },\n      ]);\n    } else if (imageOptions.removeTransparency) {\n      sharpBuffer.flatten();\n    }\n\n    if (imageOptions.borderRadius) {\n      const mask = Buffer.from(\n        `<svg><rect x=\"0\" y=\"0\" width=\"${width}\" height=\"${height}\" \n        rx=\"${imageOptions.borderRadius}\" ry=\"${imageOptions.borderRadius}\" \n        fill=\"${\n          backgroundColor && backgroundColor !== 'transparent' ? backgroundColor : 'none'\n        }\" /></svg>`\n      );\n      sharpBuffer.composite([{ input: mask, blend: 'dest-over' }]);\n    }\n\n    return await sharpBuffer.png().toBuffer();\n  } catch ({ message }) {\n    throw new Error(\n      `It was not possible to generate splash screen '${imageOptions.src}'. ${message}`\n    );\n  }\n}\n\nasync function getSharpAsync(): Promise<any> {\n  let sharp: any;\n  if (await Sharp.isAvailableAsync()) sharp = await Sharp.findSharpInstanceAsync();\n  return sharp;\n}\n\nfunction getDimensionsId(imageOptions: Pick<ImageOptions, 'width' | 'height'>): string {\n  return imageOptions.width === imageOptions.height\n    ? `${imageOptions.width}`\n    : `${imageOptions.width}x${imageOptions.height}`;\n}\n\nasync function maybeWarnAboutInstallingSharpAsync() {\n  // Putting the warning here will prevent the warning from showing if all images were reused from the cache\n  if (!hasWarned && !(await Sharp.isAvailableAsync())) {\n    hasWarned = true;\n    console.warn(\n      chalk.yellow(\n        `Using node to generate images. This is much slower than using native packages.\\n\\u203A Optionally you can stop the process and try again after successfully running \\`npm install -g sharp-cli\\`.\\n`\n      )\n    );\n  }\n}\n\nasync function ensureImageOptionsAsync(imageOptions: ImageOptions): Promise<ImageOptions> {\n  const icon = {\n    ...imageOptions,\n    src: await Download.downloadOrUseCachedImage(imageOptions.src),\n  };\n\n  // Default to contain\n  if (!icon.resizeMode) {\n    icon.resizeMode = 'contain';\n  }\n\n  const mimeType = mime.getType(icon.src);\n\n  if (!mimeType) {\n    throw new Error(`Invalid mimeType for image with source: ${icon.src}`);\n  }\n  if (!supportedMimeTypes.includes(mimeType)) {\n    throw new Error(`Supplied image is not a supported image type: ${imageOptions.src}`);\n  }\n\n  if (!icon.name) {\n    icon.name = `icon_${getDimensionsId(imageOptions)}.${mime.getExtension(mimeType)}`;\n  }\n\n  return icon;\n}\n\nexport async function generateImageAsync(\n  options: { projectRoot: string; cacheType?: string },\n  imageOptions: ImageOptions\n): Promise<{ source: Buffer; name: string }> {\n  const icon = await ensureImageOptionsAsync(imageOptions);\n\n  if (!options.cacheType) {\n    await maybeWarnAboutInstallingSharpAsync();\n    return { name: icon.name!, source: await resizeAsync(icon) };\n  }\n\n  const cacheKey = await Cache.createCacheKeyWithDirectoryAsync(\n    options.projectRoot,\n    options.cacheType,\n    icon\n  );\n\n  const name = icon.name!;\n  let source: Buffer | null = await Cache.getImageFromCacheAsync(name, cacheKey);\n\n  if (!source) {\n    await maybeWarnAboutInstallingSharpAsync();\n    source = await resizeAsync(icon);\n    await Cache.cacheImageAsync(name, source, cacheKey);\n  }\n\n  return { name, source };\n}\n\nexport async function generateFaviconAsync(\n  pngImageBuffer: Buffer,\n  sizes: number[] = [16, 32, 48]\n): Promise<Buffer> {\n  const buffers = await resizeImagesAsync(pngImageBuffer, sizes);\n  return await Ico.generateAsync(buffers);\n}\n\n/**\n * Layers the provided foreground image over the provided background image.\n *\n * @param foregroundImageBuffer\n * @param foregroundImageBuffer\n * @param x pixel offset from the left edge, defaults to 0.\n * @param y pixel offset from the top edge, defaults to 0.\n */\nexport async function compositeImagesAsync({\n  foreground,\n  background,\n  x = 0,\n  y = 0,\n}: {\n  foreground: Buffer;\n  background: Buffer;\n  x?: number;\n  y?: number;\n}): Promise<Buffer> {\n  const sharp: any = await getSharpAsync();\n  if (!sharp) {\n    const image = (await Jimp.getJimpImageAsync(background)).composite(\n      await Jimp.getJimpImageAsync(foreground),\n      x,\n      y\n    );\n    return await image.getBufferAsync(image.getMIME());\n  }\n  return await sharp(background)\n    .composite([{ input: foreground, left: x, top: y }])\n    .toBuffer();\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"script"}